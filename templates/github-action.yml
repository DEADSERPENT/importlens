name: ImportLens - Unused Import Check

# Trigger on pull requests and pushes to main/master
on:
  pull_request:
    branches: [ main, master, develop ]
  push:
    branches: [ main, master, develop ]
  workflow_dispatch: # Allow manual trigger

jobs:
  check-imports:
    name: Check for Unused Imports
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install ImportLens CLI
        run: npm install -g importlens

      # Option 1: Standard check (fails on any unused imports)
      - name: Check for unused imports
        run: importlens-cli --check --format=github src/
        continue-on-error: false

      # Option 2: Baseline mode (only fails on NEW unused imports)
      # Uncomment the following steps to use baseline mode
      # - name: Check for new unused imports (baseline mode)
      #   run: importlens-cli --check --baseline-check src/
      #   continue-on-error: false

      # Optional: Upload results as artifact
      - name: Generate JSON report
        if: always()
        run: importlens-cli --check --format=json src/ > importlens-report.json || true

      - name: Upload report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: importlens-report
          path: importlens-report.json

      # Optional: Comment results on PR
      - name: Comment PR with results
        if: github.event_name == 'pull_request' && failure()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let report = '';
            try {
              report = fs.readFileSync('importlens-report.json', 'utf8');
              const data = JSON.parse(report);
              const totalIssues = data.reduce((sum, file) => sum + file.unusedImports.length, 0);

              const comment = `## ImportLens Report

              ⚠️ Found ${totalIssues} unused imports in ${data.length} file(s).

              Please review and remove unused imports before merging.

              <details>
              <summary>View Details</summary>

              \`\`\`json
              ${JSON.stringify(data, null, 2)}
              \`\`\`

              </details>`;

              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            } catch (error) {
              console.log('Could not post comment:', error);
            }
